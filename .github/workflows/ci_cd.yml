name: ğŸ—ï¸ AI Architect CI/CD Pipeline

# 1. EL GATILLO (Trigger)
# Esto se activa cada vez que haces un PUSH a la rama 'main'
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

# 2. LAS TAREAS (Jobs)
jobs:
  build-and-test:
    name: ğŸ§ª Build & Test Docker Architecture
    runs-on: ubuntu-latest # GitHub nos presta un servidor Linux GRATIS

    steps:
    # A. Descargar tu cÃ³digo del repo
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3

    # B. Configurar Docker
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    # C. Instalar Docker Compose (versiÃ³n moderna)
    - name: ğŸ”§ Install Docker Compose
      run: |
        sudo apt-get update
        sudo apt-get install docker-compose-plugin
        docker compose version

    # D. LA PRUEBA DE FUEGO
    # Construimos y levantamos todo. Si algo falla aquÃ­, el pipeline se rompe (Rojo).
    - name: ğŸ”¨ Build and Start Services
      run: |
        echo "ğŸš€ Construyendo imÃ¡genes..."
        docker compose build
        
        echo "ğŸ”¥ Levantando infraestructura..."
        docker compose up -d
        
        echo "ğŸ•µï¸ Verificando estado..."
        docker compose ps
        
        echo "â³ Esperando 10s para estabilizaciÃ³n..."
        sleep 10
        
        echo "âœ… Verificando que los contenedores siguen vivos..."
        if [ $(docker compose ps -q | wc -l) -lt 3 ]; then
          echo "âŒ ERROR: Algunos contenedores murieron."
          docker compose logs
          exit 1
        else
          echo "ğŸ‰ Ã‰XITO: Todos los sistemas operativos."
        fi

    # E. Limpieza
    - name: ğŸ§¹ Teardown
      run: docker compose down
